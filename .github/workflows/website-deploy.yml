name: Website Deploy

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "apps/website/**"
      - ".github/workflows/website-deploy.yml"

concurrency:
  group: website-deploy-main
  cancel-in-progress: false

jobs:
  website-checks:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/website
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: apps/website/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run lint
        run: npm run lint

      - name: Build website
        run: npm run build

  deploy:
    runs-on: ubuntu-latest
    needs: website-checks
    env:
      DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
      DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
      APP_ROOT: /var/www/boltroute-website
      APP_ENV_REMOTE: /var/www/boltroute-website/shared/.env.local
      WEBSITE_SERVICE: boltroute-website
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Trust deploy host key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${DEPLOY_HOST}" >> ~/.ssh/known_hosts

      - name: Prepare release id
        run: echo "RELEASE_ID=$(date +%Y%m%d%H%M%S)" >> "$GITHUB_ENV"

      - name: Create release directory
        run: |
          ssh "${DEPLOY_USER}@${DEPLOY_HOST}" \
            "mkdir -p ${APP_ROOT}/releases/${RELEASE_ID} ${APP_ROOT}/shared"

      - name: Upload env file
        env:
          WEBSITE_APP_ENV_LOCAL: ${{ secrets.WEBSITE_APP_ENV_LOCAL }}
        run: |
          set -euo pipefail
          app_env_file="$(mktemp)"
          printf '%s' "${WEBSITE_APP_ENV_LOCAL}" > "${app_env_file}"

          upsert_if_missing_or_blank() {
            local key="$1"
            local source_file="$2"
            if [ ! -f "${source_file}" ]; then
              return
            fi
            local line
            line="$(grep -m1 -E "^${key}=" "${source_file}" || true)"
            if [ -z "${line}" ]; then
              return
            fi
            local source_value
            source_value="${line#*=}"
            if [ -z "${source_value}" ] || [ "${source_value}" = "\"\"" ] || [ "${source_value}" = "''" ]; then
              return
            fi

            if grep -qE "^${key}=" "${app_env_file}"; then
              local current_line
              current_line="$(grep -m1 -E "^${key}=" "${app_env_file}" || true)"
              local current_value
              current_value="${current_line#*=}"
              if [ -n "${current_value}" ] && [ "${current_value}" != "\"\"" ] && [ "${current_value}" != "''" ]; then
                return
              fi
              sed -i "/^${key}=/d" "${app_env_file}"
            fi

            printf '\n%s\n' "${line}" >> "${app_env_file}"
          }

          for env_source in "./apps/dashboard/backend/.env" "./apps/dashboard/backend/.env.local"; do
            upsert_if_missing_or_blank "SMTP_SERVER" "${env_source}"
            upsert_if_missing_or_blank "SMTP_PORT" "${env_source}"
            upsert_if_missing_or_blank "SMTP_USERNAME" "${env_source}"
            upsert_if_missing_or_blank "SMTP_PASSWORD" "${env_source}"
            upsert_if_missing_or_blank "SMTP_STARTTLS_REQUIRED" "${env_source}"
            upsert_if_missing_or_blank "SMTP_FROM_EMAIL" "${env_source}"
            upsert_if_missing_or_blank "SMTP_FROM_NAME" "${env_source}"
            upsert_if_missing_or_blank "SMTP_REPLY_TO" "${env_source}"
            upsert_if_missing_or_blank "CONTACT_NOTIFICATION_TO_EMAIL" "${env_source}"
            upsert_if_missing_or_blank "CONTACT_SMTP_TIMEOUT_MS" "${env_source}"
            upsert_if_missing_or_blank "CONTACT_SMTP_ENVELOPE_FROM" "${env_source}"
            upsert_if_missing_or_blank "CONTACT_SMTP_SENDER_EMAIL" "${env_source}"
          done

          scp "${app_env_file}" "${DEPLOY_USER}@${DEPLOY_HOST}:${APP_ENV_REMOTE}"
          ssh "${DEPLOY_USER}@${DEPLOY_HOST}" \
            "chmod 600 ${APP_ENV_REMOTE}"
          rm -f "${app_env_file}"

      - name: Sync release
        run: |
          rsync -a --delete \
            --exclude .git \
            --exclude .github \
            --exclude node_modules \
            --exclude .next \
            --exclude .env \
            --exclude .env.* \
            --exclude .env.local \
            ./apps/website/ "${DEPLOY_USER}@${DEPLOY_HOST}:${APP_ROOT}/releases/${RELEASE_ID}/"

      - name: Deploy release
        run: |
          ssh "${DEPLOY_USER}@${DEPLOY_HOST}" \
            "APP_ROOT='${APP_ROOT}' \
            RELEASE_ID='${RELEASE_ID}' \
            APP_ENV_FILE='${APP_ENV_REMOTE}' \
            WEBSITE_SERVICE='${WEBSITE_SERVICE}' \
            bash '${APP_ROOT}/releases/${RELEASE_ID}/deploy/remote-deploy.sh'"
