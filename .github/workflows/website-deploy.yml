name: Website Deploy

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "apps/website/**"
      - ".github/workflows/website-deploy.yml"

concurrency:
  group: website-deploy-main
  cancel-in-progress: false

jobs:
  website-checks:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/website
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: apps/website/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run lint
        run: npm run lint

      - name: Build website
        run: npm run build

  deploy:
    runs-on: ubuntu-latest
    needs: website-checks
    env:
      DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
      DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
      APP_ROOT: /var/www/boltroute-website
      APP_ENV_REMOTE: /var/www/boltroute-website/shared/.env.local
      WEBSITE_SERVICE: boltroute-website
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Trust deploy host key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${DEPLOY_HOST}" >> ~/.ssh/known_hosts

      - name: Prepare release id
        run: echo "RELEASE_ID=$(date +%Y%m%d%H%M%S)" >> "$GITHUB_ENV"

      - name: Create release directory
        run: |
          ssh "${DEPLOY_USER}@${DEPLOY_HOST}" \
            "mkdir -p ${APP_ROOT}/releases/${RELEASE_ID} ${APP_ROOT}/shared"

      - name: Upload env file
        env:
          WEBSITE_APP_ENV_LOCAL: ${{ secrets.WEBSITE_APP_ENV_LOCAL }}
        run: |
          set -euo pipefail
          app_env_file="$(mktemp)"
          printf '%s' "${WEBSITE_APP_ENV_LOCAL}" > "${app_env_file}"
          scp "${app_env_file}" "${DEPLOY_USER}@${DEPLOY_HOST}:${APP_ENV_REMOTE}"
          ssh "${DEPLOY_USER}@${DEPLOY_HOST}" \
            "chmod 600 ${APP_ENV_REMOTE}"
          rm -f "${app_env_file}"

      - name: Sync release
        run: |
          rsync -a --delete \
            --exclude .git \
            --exclude .github \
            --exclude node_modules \
            --exclude .next \
            --exclude .env \
            --exclude .env.* \
            --exclude .env.local \
            ./apps/website/ "${DEPLOY_USER}@${DEPLOY_HOST}:${APP_ROOT}/releases/${RELEASE_ID}/"

      - name: Deploy release
        run: |
          ssh "${DEPLOY_USER}@${DEPLOY_HOST}" \
            "APP_ROOT='${APP_ROOT}' \
            RELEASE_ID='${RELEASE_ID}' \
            APP_ENV_FILE='${APP_ENV_REMOTE}' \
            WEBSITE_SERVICE='${WEBSITE_SERVICE}' \
            bash '${APP_ROOT}/releases/${RELEASE_ID}/deploy/remote-deploy.sh'"
